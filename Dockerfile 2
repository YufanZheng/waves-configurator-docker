FROM phusion/baseimage

MAINTAINER yufan.zheng@atos.com

#############################################################################
# Front-end angular 2.x served by nginx
#############################################################################

# Angular Cli require Version of NodeJS 6.9.0 + 
ENV NODEJS_VERSION 7.x
ENV ANGULAR_CLI_VERSION 1.0.0-beta.28.3

# Install NodeJS and npm
RUN curl -sL https://deb.nodesource.com/setup_$NODEJS_VERSION | bash - && \
    apt-get install python-software-properties python g++ make -y && \
    add-apt-repository -y -r ppa:chris-lea/node.js && \
    rm -f /etc/apt/sources.list.d/chris-lea-node_js-*.list && \
    apt-get update && \
    apt-get install nodejs -y

# Install Angular Cli
RUN npm install -g @angular/cli

# Configure work path
ENV APP_PATH /app
ENV PATH $APP_PATH/node_modules/@angular/cli/bin/:$PATH

# Switch to work path
RUN mkdir $APP_PATH
WORKDIR $APP_PATH

# Upload front-end code
COPY ./resources/front-end .

# Download angular nodejs dependencies and build program
RUN npm install

# Forwarding ports for Angular
EXPOSE 4200

# Install useful tools and Supervisord
RUN apt-get update && \
    apt-get install -y wget supervisor vim software-properties-common net-tools && \
    add-apt-repository main && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean

# Configure Supervisor to display web interface
RUN rm /etc/supervisor/supervisord.conf
ADD supervisor/supervisord.conf /etc/supervisor/

# Put angular, tomcat under Supervisor for automatic launch and control
ADD supervisor/angular.conf /etc/supervisor/conf.d

# Forwarding ports for supervisor
EXPOSE 9001

CMD ["/usr/bin/supervisord", "-n"]